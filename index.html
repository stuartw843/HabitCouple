<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Couples Habit Tracker (Fully Functional)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      background-color: #f0f8ff;
      font-family: Arial, sans-serif;
    }
    .navbar-brand {
      font-weight: bold;
    }
    table {
      white-space: nowrap;
    }
    @media (max-width: 576px) {
      h2.h5,
      .navbar-brand {
        font-size: 1rem;
      }
      .btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
      }
      .table th, .table td {
        padding: 0.3rem;
        font-size: 0.75rem;
      }
      .heart-btn {
        font-size: 1rem;
      }
      .sync-indicator {
        font-size: 0.8rem;
        margin-left: 0.5rem;
        padding: 0.15rem 0.3rem;
      }
      /* Hide table on small screens */
      .table-responsive {
        display: none;
      }
      /* Show cards on small screens */
      .cards-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .habit-card {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .habit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      .habit-title {
        font-size: 1rem;
        font-weight: bold;
      }
      .streak {
        color: #ff4500;
        font-size: 1rem;
      }
      .days-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .day-item {
        flex: 1 1 30%;
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.5rem;
        background-color: #f8f9fa;
      }
      .day-label {
        font-size: 0.8rem;
        margin-bottom: 0.3rem;
      }
      .progress-info {
        font-size: 0.8rem;
        text-align: center;
      }
      /* Highlight current day in card layout */
      .day-item.today-cell {
        background-color: #fff3cd;
      }
      /* Styles for Multi-Select Dropdown */
      .dropdown-menu.multi-select-dropdown {
        max-height: 300px;
        overflow-y: auto;
      }
      .dropdown-item {
        display: flex;
        align-items: center;
      }
      .dropdown-item input {
        margin-right: 0.5rem;
      }
    }

    /* Hide cards on larger screens */
    @media (min-width: 577px) {
      .cards-container {
        display: none;
      }
    }

    .heart-btn {
      cursor: pointer;
      font-size: 1.25rem;
      user-select: none;
      transition: color 0.2s;
      line-height: 1;
    }
    .heart-btn.empty {
      color: #ccc;
    }
    .heart-btn.filled {
      color: #ff69b4;
    }
    .fire-icon {
      color: #ff4500;
      margin-left: 0.25rem;
    }
    .analytics-bar-bg {
      background-color: #e9ecef;
      width: 100%;
      border-radius: 0.25rem;
    }
    .analytics-bar {
      height: 1rem;
      background-color: #ff69b4;
      transition: width 0.3s;
      border-radius: 0.25rem;
    }
    .today-cell {
      background-color: #fff3cd !important;
    }
    .modal-feeling {
      padding: 1rem;
      border-radius: 0.25rem;
      transition: background-color 0.2s;
    }
    .feeling-Great {
      background-color: #d1e7dd !important;
      color: #0f5132 !important;
    }
    .feeling-Good {
      background-color: #cff4fc !important;
      color: #055160 !important;
    }
    .feeling-Meh {
      background-color: #fff3cd !important;
      color: #664d03 !important;
    }
    .feeling-Bad {
      background-color: #f8d7da !important;
      color: #842029 !important;
    }
    .feeling-None {
      background-color: #e2e3e5 !important;
      color: #41464b !important;
    }
    .details-btn {
      transition: background-color 0.2s, color 0.2s;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    .sync-indicator {
      font-size: 0.9rem;
      margin-left: 1rem;
      padding: 0.2rem 0.5rem;
      border-radius: 0.25rem;
      white-space: nowrap;
    }
    .sync-indicator.connecting {
      background-color: #0dcaf0;
      color: #212529;
    }
    .sync-indicator.connected {
      background-color: #198754;
      color: #fff;
    }
    .sync-indicator.error {
      background-color: #dc3545;
      color: #fff;
    }
    .sync-indicator.idle {
      background-color: #6c757d;
      color: #fff;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#/home">Couples Habit Tracker</a>
      <!-- Firestore Status Always Visible -->
      <span id="syncIndicator" class="sync-indicator idle me-3">Idle</span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" 
              aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarContent">
        <div class="ms-auto d-flex align-items-center gap-2">
          <!-- Multi-Select Dropdown for Partners -->
          <div class="dropdown">
            <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="dropdownPartners" data-bs-toggle="dropdown" aria-expanded="false">
              Select Partners
            </button>
            <ul class="dropdown-menu multi-select-dropdown" aria-labelledby="dropdownPartners" id="partnersDropdown">
              <!-- Dynamically populated with partners -->
            </ul>
          </div>
          <a class="btn btn-outline-light btn-sm" href="#/home">Home</a>
          <a class="btn btn-outline-light btn-sm" href="#/analytics">Analytics</a>
          <a class="btn btn-outline-light btn-sm" href="#/settings">Settings</a>
        </div>
      </div>
    </div>
  </nav>
  <div class="container py-3" id="app"></div>

  <!-- Bootstrap JS Bundle -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>
  <script>
    // Initialize Variables
    let firestoreSettings = null;
    let firestore = null;
    let firestoreState = 'idle';
    const FIRESTORE_CONFIG_STORAGE_KEY = 'couples-habit-tracker-firestore-config';
    const STORAGE_KEY = 'couples-habit-tracker-fun';
    const SELECTED_PARTNERS_KEY = 'couples-habit-tracker-selected-partners'; // New key for selected partners
    let dataStore = { partners: [] };
    let weekOffset = 0;
    let analyticsView = 'weekly';
    let selectedPartners = []; // Array to hold selected partner indices

    // Firestore State Management
    function setFirestoreState(state) {
      firestoreState = state;
      updateSyncIndicator();
    }
    function updateSyncIndicator() {
      const ind = document.getElementById('syncIndicator');
      ind.className = `sync-indicator ${firestoreState}`;
      ind.textContent = firestoreState.charAt(0).toUpperCase() + firestoreState.slice(1);
    }

    // Load selected partners from localStorage
    function loadSelectedPartners() {
      const savedSelection = localStorage.getItem(SELECTED_PARTNERS_KEY);
      if (savedSelection) {
        try {
          selectedPartners = JSON.parse(savedSelection);
        } catch {
          selectedPartners = [];
        }
      } else {
        // Default to all partners selected if no selection is saved
        selectedPartners = dataStore.partners.map((_, index) => index);
      }
    }

    // Save selected partners to localStorage
    function saveSelectedPartners() {
      localStorage.setItem(SELECTED_PARTNERS_KEY, JSON.stringify(selectedPartners));
    }

    // Initialize the multi-select dropdown
    function initPartnersDropdown() {
      const dropdown = document.getElementById('partnersDropdown');
      dropdown.innerHTML = ''; // Clear existing options
      dataStore.partners.forEach((partner, index) => {
        const listItem = document.createElement('li');
        listItem.innerHTML = `
          <a class="dropdown-item" href="#">
            <input type="checkbox" class="me-2" data-partner-index="${index}" ${selectedPartners.includes(index) ? 'checked' : ''}>
            ${partner.name}
          </a>
        `;
        dropdown.appendChild(listItem);
      });

      // Attach event listeners to checkboxes
      dropdown.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const pIndex = parseInt(e.target.getAttribute('data-partner-index'));
          if (e.target.checked) {
            if (!selectedPartners.includes(pIndex)) {
              selectedPartners.push(pIndex);
            }
          } else {
            selectedPartners = selectedPartners.filter(index => index !== pIndex);
          }
          saveSelectedPartners();
          renderHomePage();
          renderAnalyticsPage();
        });
      });
    }

    // Load Data from localStorage and Firestore
    const savedLocal = localStorage.getItem(STORAGE_KEY);
    if (savedLocal) {
      try {
        dataStore = JSON.parse(savedLocal);
      } catch {}
    }
    const savedFirestoreConfig = localStorage.getItem(FIRESTORE_CONFIG_STORAGE_KEY);
    if (savedFirestoreConfig) {
      try {
        firestoreSettings = JSON.parse(savedFirestoreConfig);
      } catch {}
    }

    // Initialize Firestore
    function initFirestore(config) {
      setFirestoreState('connecting');
      try {
        // Prevent initializing multiple Firebase apps
        if (!firebase.apps.length) {
          firebase.initializeApp(config);
        }
        firestore = firebase.firestore();
        attachFirestoreListener();
      } catch (err) {
        firestore = null;
        console.error('Error init Firestore:', err);
        setFirestoreState('error');
        alert(`Error: ${err.message}`);
      }
    }

    // Attach Firestore Listener
    function attachFirestoreListener() {
      if (!firestore) {
        setFirestoreState('idle');
        return;
      }
      const docRef = firestore.collection('habitTrackers').doc('default');
      docRef.onSnapshot(
        (doc) => {
          if (doc.exists) {
            dataStore = doc.data() || { partners: [] };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataStore));
            setFirestoreState('connected');
            loadSelectedPartners(); // Reload selected partners after data update
            initPartnersDropdown(); // Re-initialize dropdown with updated partners
            router();
          } else {
            setFirestoreState('connected');
          }
        },
        (err) => {
          console.error('Firestore listener error:', err);
          setFirestoreState('error');
          alert(`Firestore error: ${err.message}`);
        }
      );
    }

    // Save Data to localStorage and Firestore
    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(dataStore));
      if (firestore) {
        setFirestoreState('connecting');
        firestore
          .collection('habitTrackers')
          .doc('default')
          .set(dataStore)
          .then(() => {
            setFirestoreState('connected');
          })
          .catch((err) => {
            console.error('Error saving Firestore:', err);
            setFirestoreState('error');
            alert(`Error saving Firestore: ${err.message}`);
          });
      }
    }

    // Routing Setup
    const routes = {
      '/home': renderHomePage,
      '/analytics': renderAnalyticsPage,
      '/settings': renderSettingsPage
    };
    function router() {
      const hash = window.location.hash || '#/home';
      const path = hash.replace('#','');
      (routes[path] || routes['/home'])();
    }
    window.addEventListener('hashchange', router);
    window.addEventListener('load', () => {
      if (firestoreSettings) {
        initFirestore(firestoreSettings);
      } else {
        setFirestoreState('idle');
        loadSelectedPartners();
        initPartnersDropdown();
        router();
      }
    });

    // Utility Function to Get Monday's Week Dates
    function getMondayWeekDates(offset=0){
      const now=new Date();
      const dayOfWeek=(now.getDay()+6)%7; // Make Monday = 0
      now.setDate(now.getDate()-dayOfWeek + offset*7);
      const arr=[];
      for(let i=0;i<7;i++){
        const d=new Date(now);
        d.setDate(now.getDate()+i);
        const dateStr=d.toISOString().split('T')[0];
        const label=d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
        arr.push({dateStr,label});
      }
      return arr;
    }

    // Compute Weekly Streak
    function computeWeeklyStreak(habit){
      if(habit.frequency !== 'weekly') return 0; // Only compute streak for weekly habits
      const now = new Date();
      let streak = 0;
      let weekOffset = 0; // Current week
      while(true){
        const weekDates = getMondayWeekDates(weekOffset);
        const count = weekDates.reduce((acc, day) => {
          if(habit.logs[day.dateStr] && habit.logs[day.dateStr].checked){
            return acc +1;
          }
          return acc;
        }, 0);
        const weeklyGoal = habit.goal >0 ? habit.goal : 7;
        if(count >= weeklyGoal){
          streak++;
          weekOffset--;
        } else if (count<weeklyGoal && weekOffset==0){
          weekOffset--;
          }
        else {
          break;
        }
      }
      return streak;
    }

    // Compute Goal Progress
    function computeGoalProgress(habit, days){
      let c=0;
      if(habit.frequency === 'weekly'){
        days.forEach(({dateStr})=>{
          if(habit.logs[dateStr]?.checked)c++;
        });
        const weeklyGoal = habit.goal >0 ? habit.goal :7;
        const percent=Math.round((c/weeklyGoal)*100);
        return {count: c, percent: percent};
      }
      else if(habit.frequency === 'yearly'){
        const now = new Date();
        const currentYear = now.getFullYear();
        Object.keys(habit.logs).forEach(d =>{
          const date = new Date(d);
          if(date.getFullYear() === currentYear && habit.logs[d].checked){
            c++;
          }
        });
        const yearlyGoal = habit.goal >0 ? habit.goal :1;
        const percent=Math.round((c/yearlyGoal)*100);
        return {count: c, percent: percent};
      }
      return {count:0, percent:0};
    }

    // Render Home Page
    function renderHomePage(){
      const app=document.getElementById('app');
      const days=getMondayWeekDates(weekOffset);
      const todayStr=new Date().toISOString().split('T')[0];
      if(!dataStore.partners.length){
        app.innerHTML=`
          <div class="text-center mt-5">
            <h3>Welcome!</h3>
            <p class="text-muted">No partners yet. <a href="#/settings">Add some</a>.</p>
          </div>
        `;
        return;
      }
      if(selectedPartners.length === 0){
        app.innerHTML=`
          <div class="text-center mt-5">
            <h4>No Partners Selected</h4>
            <p class="text-muted">Please select at least one partner from the dropdown above.</p>
          </div>
        `;
        return;
      }
      let html=`
        <!-- Controls -->
        <div class="d-flex justify-content-center align-items-center mb-3 gap-2 flex-wrap">
          <button id="btnPrev" class="btn btn-sm btn-secondary">← Prev</button>
          <button id="btnThisWeek" class="btn btn-sm btn-light">This Week</button>
          <button id="btnNext" class="btn btn-sm btn-secondary">Next →</button>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="detailsModal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content" id="detailsModalContent"></div>
          </div>
        </div>

        <!-- Table for larger screens -->
        <div class="table-responsive d-none d-sm-block">
          <table class="table table-bordered align-middle text-center">
            <thead class="table-light">
              <tr>
                <th style="min-width:160px;">Habit</th>
      `;
      days.forEach(({label,dateStr})=>{
        html+=`
          <th style="width:120px;">
            <div>${label}</div>
            <div class="small text-muted">${dateStr}</div>
          </th>
        `;
      });
      html+=`
                <th>Progress</th>
              </tr>
            </thead>
            <tbody>
      `;
      selectedPartners.forEach(pIndex=>{
        const partner = dataStore.partners[pIndex];
        partner.habits.forEach((habit,hIndex)=>{
          if(!habit.logs) habit.logs={};
          const {count, percent} = computeGoalProgress(habit, days);
          let progressInfo = '';
          let streakInfo = '';
          let displayDays = '';
          if(habit.frequency === 'weekly'){
            const weeklyGoal = habit.goal >0 ? habit.goal :7;
            const currStreak = computeWeeklyStreak(habit);
            const progressColor = count >= weeklyGoal ? 'bg-success' : 'bg-warning';
            streakInfo = currStreak >0 ? `<span class="fire-icon">🔥 Streak: ${currStreak} week(s)</span>` : '';
            displayDays = days.map(({dateStr})=>{
              if(!habit.logs[dateStr]){
                habit.logs[dateStr]={checked:false,notes:'',feeling:'None'};
              }
              const logs=habit.logs[dateStr];
              const isFilled=logs.checked?'filled':'empty';
              const highlight=dateStr===todayStr?'today-cell':'';
              return `
                <td class="${highlight}">
                  <span
                    class="heart-btn ${isFilled}"
                    data-partner-index="${pIndex}"
                    data-habit-index="${hIndex}"
                    data-datestr="${dateStr}"
                  >
                    ${isFilled==='filled'?'♥':'♡'}
                  </span>
                  <br />
                  <button
                    class="btn btn-sm details-btn mt-1 feeling-${logs.feeling}"
                    data-partner-index="${pIndex}"
                    data-habit-index="${hIndex}"
                    data-datestr="${dateStr}"
                    data-bs-toggle="modal"
                    data-bs-target="#detailsModal"
                  >
                    Details
                  </button>
                </td>
              `;
            }).join('');
            progressInfo = `
              <div class="progress">
                <div class="progress-bar ${progressColor}" role="progressbar" style="width: ${percent > 100 ? 100 : percent}%;" aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="text-muted">${count}/${weeklyGoal} (${percent}%)</small>
            `;
          }
          else if(habit.frequency === 'yearly'){
            const yearlyGoal = habit.goal >0 ? habit.goal :1;
            const progressColor = count >= yearlyGoal ? 'bg-success' : 'bg-info';
            displayDays = days.map(({dateStr})=>{
              if(!habit.logs[dateStr]){
                habit.logs[dateStr]={checked:false,notes:'',feeling:'None'};
              }
              const logs=habit.logs[dateStr];
              const isFilled=logs.checked?'filled':'empty';
              const highlight=dateStr===todayStr?'today-cell':'';
              return `
                <td class="${highlight}">
                  <span
                    class="heart-btn ${isFilled}"
                    data-partner-index="${pIndex}"
                    data-habit-index="${hIndex}"
                    data-datestr="${dateStr}"
                  >
                    ${isFilled==='filled'?'♥':'♡'}
                  </span>
                  <br />
                  <button
                    class="btn btn-sm details-btn mt-1 feeling-${logs.feeling}"
                    data-partner-index="${pIndex}"
                    data-habit-index="${hIndex}"
                    data-datestr="${dateStr}"
                    data-bs-toggle="modal"
                    data-bs-target="#detailsModal"
                  >
                    Details
                  </button>
                </td>
              `;
            }).join('');
            progressInfo = `
              <div class="progress">
                <div class="progress-bar ${progressColor}" role="progressbar" style="width: ${percent > 100 ? 100 : percent}%;" aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="text-muted">${count}/${yearlyGoal} (${percent}%)</small>
            `;
          }

          html+=`
            <tr>
              <td class="text-start">
                <strong>${partner.name} - ${habit.title}</strong>
                <br>
                <small class="text-muted">(${habit.frequency.charAt(0).toUpperCase() + habit.frequency.slice(1)} Goal: ${habit.frequency === 'weekly' ? (habit.goal >0 ? habit.goal :7) : (habit.goal >0 ? habit.goal :1)})</small>
                ${streakInfo}
              </td>
              ${displayDays}
              <td>
                ${progressInfo}
              </td>
            </tr>
          `;
        });
      });
      html+=`</tbody></table></div>`;

      // Cards for small screens
      html+=`<div class="cards-container d-block d-sm-none">`;
      selectedPartners.forEach(pIndex=>{
        const partner = dataStore.partners[pIndex];
        partner.habits.forEach((habit,hIndex)=>{
          if(!habit.logs) habit.logs={};
          const {count, percent} = computeGoalProgress(habit, days);
          let progressInfo = '';
          let streakInfo = '';
          let displayDays = '';
          if(habit.frequency === 'weekly'){
            const weeklyGoal = habit.goal >0 ? habit.goal :7;
            const currStreak = computeWeeklyStreak(habit);
            const progressColor = count >= weeklyGoal ? 'bg-success' : 'bg-warning';
            streakInfo = currStreak >0 ? `<span class="streak">🔥 Streak: ${currStreak} week(s)</span>` : '';
            displayDays = days.map(({dateStr, label})=>{
              if(!habit.logs[dateStr]){
                habit.logs[dateStr]={checked:false,notes:'',feeling:'None'};
              }
              const logs=habit.logs[dateStr];
              const isFilled=logs.checked?'filled':'empty';
              const highlight=dateStr===todayStr?'today-cell':'';
              return `
                <div class="day-item ${highlight}">
                  <div class="day-label">${label}</div>
                  <span
                    class="heart-btn ${isFilled}"
                    data-partner-index="${pIndex}"
                    data-habit-index="${hIndex}"
                    data-datestr="${dateStr}"
                  >
                    ${isFilled==='filled'?'♥':'♡'}
                  </span>
                  <button
                    class="btn btn-sm details-btn mt-1 feeling-${logs.feeling}"
                    data-partner-index="${pIndex}"
                    data-habit-index="${hIndex}"
                    data-datestr="${dateStr}"
                    data-bs-toggle="modal"
                    data-bs-target="#detailsModal"
                  >
                    Details
                  </button>
                </div>
              `;
            }).join('');
            progressInfo = `
              <div class="progress mb-1">
                <div class="progress-bar ${progressColor}" role="progressbar" style="width: ${percent > 100 ? 100 : percent}%;" aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="text-muted">Progress: ${count}/${weeklyGoal} (${percent}%)</small>
            `;
          }
          else if(habit.frequency === 'yearly'){
            const yearlyGoal = habit.goal >0 ? habit.goal :1;
            const progressColor = count >= yearlyGoal ? 'bg-success' : 'bg-info';
            displayDays = days.map(({dateStr, label})=>{
              if(!habit.logs[dateStr]){
                habit.logs[dateStr]={checked:false,notes:'',feeling:'None'};
              }
              const logs=habit.logs[dateStr];
              const isFilled=logs.checked?'filled':'empty';
              const highlight=dateStr===todayStr?'today-cell':'';
              return `
                <div class="day-item ${highlight}">
                  <div class="day-label">${label}</div>
                  <span
                    class="heart-btn ${isFilled}"
                    data-partner-index="${pIndex}"
                    data-habit-index="${hIndex}"
                    data-datestr="${dateStr}"
                  >
                    ${isFilled==='filled'?'♥':'♡'}
                  </span>
                  <button
                    class="btn btn-sm details-btn mt-1 feeling-${logs.feeling}"
                    data-partner-index="${pIndex}"
                    data-habit-index="${hIndex}"
                    data-datestr="${dateStr}"
                    data-bs-toggle="modal"
                    data-bs-target="#detailsModal"
                  >
                    Details
                  </button>
                </div>
              `;
            }).join('');
            progressInfo = `
              <div class="progress mb-1">
                <div class="progress-bar ${progressColor}" role="progressbar" style="width: ${percent > 100 ? 100 : percent}%;" aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="text-muted">Progress: ${count}/${yearlyGoal} (${percent}%)</small>
            `;
          }

          html+=`
            <div class="habit-card">
              <div class="habit-header">
                <div class="habit-title">${partner.name} - ${habit.title}</div>
                ${streakInfo}
              </div>
              <div class="mb-2 text-muted">(${habit.frequency.charAt(0).toUpperCase() + habit.frequency.slice(1)} Goal: ${habit.frequency === 'weekly' ? (habit.goal >0 ? habit.goal :7) : (habit.goal >0 ? habit.goal :1)})</div>
              <div class="days-container">
                ${displayDays}
              </div>
              <div class="progress-info">
                ${progressInfo}
              </div>
            </div>
          `;
        });
      });
      html+=`</div>`;

      app.innerHTML=html;
      attachHomeEvents();
    }

    // Attach Events for Home Page
    function attachHomeEvents(){
      document.getElementById('btnPrev')?.addEventListener('click',()=>{
        weekOffset--;
        renderHomePage();
      });
      document.getElementById('btnNext')?.addEventListener('click',()=>{
        weekOffset++;
        renderHomePage();
      });
      document.getElementById('btnThisWeek')?.addEventListener('click',()=>{
        weekOffset=0;
        renderHomePage();
      });
      document.querySelectorAll('.heart-btn').forEach((el)=>{
        el.addEventListener('click',()=>{
          const pIndex=+el.dataset.partnerIndex;
          const hIndex=+el.dataset.habitIndex;
          const d=el.dataset.datestr;
          const habit=dataStore.partners[pIndex].habits[hIndex];
          if(!habit.logs[d]){
            habit.logs[d]={checked:false,notes:'',feeling:'None'};
          }
          const wasChecked=habit.logs[d].checked;
          habit.logs[d].checked=!wasChecked;
          if(wasChecked){
            habit.logs[d].notes='';
            habit.logs[d].feeling='None';
          }
          saveData();
          // Update the heart button directly
          updateHeartButton(pIndex, hIndex, d);
        });
      });
      document.querySelectorAll('.details-btn').forEach((b)=>{
        b.addEventListener('click',()=>{
          const p=+b.dataset.partnerIndex;
          const h=+b.dataset.habitIndex;
          const d=b.dataset.datestr;
          openDetailsModal(p,h,d);
        });
      });
    }

    // Open Details Modal
    function openDetailsModal(pIndex,hIndex,dateStr){
      const habit=dataStore.partners[pIndex].habits[hIndex];
      if(!habit.logs[dateStr]){
        habit.logs[dateStr]={checked:false,notes:'',feeling:'None'};
      }
      const logs=habit.logs[dateStr];
      const modal=document.getElementById('detailsModalContent');
      const feelings=['Great','Good','Meh','Bad','None'];
      let feelingOptions='';
      feelings.forEach(f=>{
        const sel=logs.feeling===f?'selected':'';
        feelingOptions+=`<option value="${f}" ${sel}>${f}</option>`;
      });
      modal.innerHTML=`
        <div class="modal-header">
          <h5 class="modal-title">Details for ${habit.title} on ${dateStr}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-feeling feeling-${logs.feeling}" id="detailsModalBody">
          <div class="mb-3">
            <label class="form-label"><strong>Notes:</strong></label>
            <textarea class="form-control" rows="3" id="modalNotes">${logs.notes||''}</textarea>
          </div>
          <div>
            <label class="form-label"><strong>Feeling:</strong></label>
            <select class="form-select" id="modalFeeling">${feelingOptions}</select>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-primary"
            id="saveDetailsBtn"
            data-bs-dismiss="modal"
          >
            Save
          </button>
        </div>
      `;
      const feelSel=document.getElementById('modalFeeling');
      feelSel.addEventListener('change',(e)=>{
        const val=e.target.value||'None';
        const body=document.getElementById('detailsModalBody');
        body.className=`modal-feeling feeling-${val}`;
      });
      document.getElementById('saveDetailsBtn').addEventListener('click',()=>{
        const n=document.getElementById('modalNotes').value;
        const f=document.getElementById('modalFeeling').value;
        // If user saves details => set heart to true
        habit.logs[dateStr].checked=true;
        habit.logs[dateStr].notes=n;
        habit.logs[dateStr].feeling=f; // Corrected variable name
        saveData();
        // Update the heart button directly
        updateHeartButton(pIndex, hIndex, dateStr);
        // No need to re-render the entire page
      });
    }

    // Update Heart Button UI
    function updateHeartButton(pIndex, hIndex, dateStr){
      const selector = `.heart-btn[data-partner-index="${pIndex}"][data-habit-index="${hIndex}"][data-datestr="${dateStr}"]`;
      const heartBtn = document.querySelector(selector);
      if(heartBtn){
        if(dataStore.partners[pIndex].habits[hIndex].logs[dateStr].checked){
          heartBtn.classList.remove('empty');
          heartBtn.classList.add('filled');
          heartBtn.textContent = '♥';
        } else {
          heartBtn.classList.remove('filled');
          heartBtn.classList.add('empty');
          heartBtn.textContent = '♡';
        }
      }
    }

    // Render Analytics Page
    function renderAnalyticsPage(){
      const app=document.getElementById('app');
      if(!dataStore.partners.length){
        app.innerHTML=`
          <div class="text-center mt-5">
            <h3>Analytics</h3>
            <p class="text-muted">No partners yet. <a href="#/settings">Add them</a>.</p>
          </div>
        `;
        return;
      }
      if(selectedPartners.length === 0){
        app.innerHTML=`
          <div class="text-center mt-5">
            <h4>No Partners Selected</h4>
            <p class="text-muted">Please select at least one partner from the dropdown above.</p>
          </div>
        `;
        return;
      }
      let html=`
        <h2 class="mb-3">Analytics</h2>
        <div class="d-flex justify-content-center gap-2 mb-3 flex-wrap">
          <button class="btn btn-outline-dark btn-sm" id="btnWeekly">Weekly</button>
          <button class="btn btn-outline-dark btn-sm" id="btnMonthly">Monthly</button>
        </div>
      `;
      if(analyticsView==='weekly'){
        html+=renderWeeklyTrends();
      }else{
        html+=renderMonthlyTrends();
      }
      app.innerHTML=html;
      attachAnalyticsEvents();
    }
    function attachAnalyticsEvents(){
      document.getElementById('btnWeekly')?.addEventListener('click',()=>{
        analyticsView='weekly';
        renderAnalyticsPage();
      });
      document.getElementById('btnMonthly')?.addEventListener('click',()=>{
        analyticsView='monthly';
        renderAnalyticsPage();
      });
    }
    function renderWeeklyTrends(){
      let html='';
      selectedPartners.forEach(pIndex=>{
        const partner = dataStore.partners[pIndex];
        if(!partner.habits||!partner.habits.length)return;
        html+=`<h4 class="mb-2">${partner.name} (Weekly)</h4>`;
        partner.habits.forEach(habit=>{
          if(habit.frequency !== 'weekly') return; // Only include weekly habits
          const weeklyGoal=habit.goal>0?habit.goal:7;
          const stat=overallCompletion(habit.logs);
          const ratio=`${stat}/${weeklyGoal}`;
          const pct=Math.round((stat/weeklyGoal)*100);
          const color=stat>=weeklyGoal?'bg-success':'bg-warning';
          html+=`
            <div class="mb-3">
              <strong>${habit.title}</strong> (Goal: ${weeklyGoal})
              <div class="progress mt-1">
                <div class="progress-bar ${color}" role="progressbar" style="width: ${pct > 100 ? 100 : pct}%;" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="text-muted">${ratio} = ${pct}%</small>
            </div>
          `;
        });
      });
      return html;
    }
    function renderMonthlyTrends(){
      let html='';
      selectedPartners.forEach(pIndex=>{
        const partner = dataStore.partners[pIndex];
        if(!partner.habits||!partner.habits.length)return;
        html+=`<h4 class="mb-2">${partner.name} (Monthly)</h4>`;
        partner.habits.forEach(habit=>{
          if(habit.frequency !== 'yearly') return; // Only include yearly habits
          const yearlyGoal = habit.goal >0 ? habit.goal :1;
          const comp=monthlyCompletion(habit.logs);
          const ratio=`${comp}/${yearlyGoal}`;
          const pct=Math.round((comp/yearlyGoal)*100);
          const color=comp>=yearlyGoal?'bg-success':'bg-info';
          html+=`
            <div class="mb-3">
              <strong>${habit.title}</strong> (Yearly Goal: ${yearlyGoal})
              <div class="progress mt-1">
                <div class="progress-bar ${color}" role="progressbar" style="width: ${pct > 100 ? 100 : pct}%;" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="text-muted">${ratio} = ${pct}%</small>
            </div>
          `;
        });
      });
      return html;
    }

    // Compute Overall Completion for Analytics
    function overallCompletion(logs){
      let c=0;
      Object.keys(logs).forEach(d=>{
        if(logs[d].checked)c++;
      });
      return c;
    }
    function monthlyCompletion(logs){
      const now=new Date();
      const y=now.getFullYear();
      const m=now.getMonth();
      let c=0;
      Object.keys(logs).forEach(d=>{
        const parts=d.split('-');
        const yy=parseInt(parts[0],10);
        const mm=parseInt(parts[1],10)-1;
        if(yy===y&&mm===m&&logs[d].checked)c++;
      });
      return c;
    }

    // Render Settings Page
    function renderSettingsPage(){
      const app = document.getElementById('app');
      let html=`
        <h2 class="mb-4">Settings</h2>
        <!-- Firestore Configuration Section -->
        <div class="mb-4">
          <h4>Firestore Configuration</h4>
          <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#firestoreConfigModal">Configure Firestore</button>
        </div>
        <!-- Add Partner Button -->
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addPartnerModal">Add Partner</button>
        <!-- Delete All Data Button -->
        <button class="btn btn-danger mb-3" id="deleteAllDataBtn" data-bs-toggle="modal" data-bs-target="#deleteAllDataModal">Delete All Data</button>
        <!-- Partners List -->
        ${dataStore.partners.length === 0 ? `
          <p class="text-muted">No partners added yet. Click "Add Partner" to get started.</p>
        ` : `
          <div class="accordion" id="partnersAccordion">
            ${dataStore.partners.map((partner, pIndex) => `
              <div class="accordion-item">
                <h2 class="accordion-header" id="heading${pIndex}">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${pIndex}" aria-expanded="false" aria-controls="collapse${pIndex}">
                    ${partner.name}
                  </button>
                </h2>
                <div id="collapse${pIndex}" class="accordion-collapse collapse" aria-labelledby="heading${pIndex}" data-bs-parent="#partnersAccordion">
                  <div class="accordion-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <span><strong>Habits:</strong></span>
                      <div>
                        <button class="btn btn-sm btn-success me-2 add-habit-btn" data-partner-index="${pIndex}" data-bs-toggle="modal" data-bs-target="#addHabitModal">Add Habit</button>
                        <button class="btn btn-sm btn-secondary edit-partner-btn" data-partner-index="${pIndex}" data-bs-toggle="modal" data-bs-target="#editPartnerModal">Edit</button>
                        <button class="btn btn-sm btn-danger ms-2 remove-partner-btn" data-partner-index="${pIndex}">Remove</button>
                      </div>
                    </div>
                    ${partner.habits.length === 0 ? `
                      <p class="text-muted">No habits added yet.</p>
                    ` : `
                      <ul class="list-group mb-3">
                        ${partner.habits.map((habit, hIndex) => `
                          <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                              <strong>${habit.title}</strong> 
                              <small class="text-muted">(${habit.frequency.charAt(0).toUpperCase() + habit.frequency.slice(1)} Goal: ${habit.frequency === 'weekly' ? (habit.goal >0 ? habit.goal :7) : (habit.goal >0 ? habit.goal :1)})</small>
                            </div>
                            <div>
                              <button class="btn btn-sm btn-secondary me-2 edit-habit-btn" data-partner-index="${pIndex}" data-habit-index="${hIndex}" data-bs-toggle="modal" data-bs-target="#editHabitModal">Edit</button>
                              <button class="btn btn-sm btn-danger remove-habit-btn" data-partner-index="${pIndex}" data-habit-index="${hIndex}">Remove</button>
                            </div>
                          </li>
                        `).join('')}
                      </ul>
                    `}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `}
        
        <!-- Firestore Configuration Modal -->
        <div class="modal fade" id="firestoreConfigModal" tabindex="-1" aria-labelledby="firestoreConfigModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <form id="firestoreConfigForm">
                <div class="modal-header">
                  <h5 class="modal-title" id="firestoreConfigModalLabel">Firestore Configuration</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="firebaseApiKey" class="form-label">API Key</label>
                    <input type="text" class="form-control" id="firebaseApiKey" required>
                  </div>
                  <div class="mb-3">
                    <label for="firebaseAuthDomain" class="form-label">Auth Domain</label>
                    <input type="text" class="form-control" id="firebaseAuthDomain" required>
                  </div>
                  <div class="mb-3">
                    <label for="firebaseProjectId" class="form-label">Project ID</label>
                    <input type="text" class="form-control" id="firebaseProjectId" required>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary">Save Configuration</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Add Partner Modal -->
        <div class="modal fade" id="addPartnerModal" tabindex="-1" aria-labelledby="addPartnerModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form id="addPartnerForm">
                <div class="modal-header">
                  <h5 class="modal-title" id="addPartnerModalLabel">Add Partner</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="partnerName" class="form-label">Partner Name</label>
                    <input type="text" class="form-control" id="partnerName" required>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary">Add Partner</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Edit Partner Modal -->
        <div class="modal fade" id="editPartnerModal" tabindex="-1" aria-labelledby="editPartnerModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form id="editPartnerForm">
                <div class="modal-header">
                  <h5 class="modal-title" id="editPartnerModalLabel">Edit Partner</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <input type="hidden" id="editPartnerIndex">
                  <div class="mb-3">
                    <label for="editPartnerName" class="form-label">Partner Name</label>
                    <input type="text" class="form-control" id="editPartnerName" required>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Add Habit Modal -->
        <div class="modal fade" id="addHabitModal" tabindex="-1" aria-labelledby="addHabitModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form id="addHabitForm">
                <div class="modal-header">
                  <h5 class="modal-title" id="addHabitModalLabel">Add Habit</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <input type="hidden" id="addHabitPartnerIndex">
                  <div class="mb-3">
                    <label for="habitTitle" class="form-label">Habit Title</label>
                    <input type="text" class="form-control" id="habitTitle" required>
                  </div>
                  <div class="mb-3">
                    <label for="habitFrequency" class="form-label">Frequency</label>
                    <select class="form-select" id="habitFrequency" required>
                      <option value="weekly">Weekly</option>
                      <option value="yearly">Yearly</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="habitGoal" class="form-label">Goal</label>
                    <input type="number" class="form-control" id="habitGoal" min="1" required>
                  </div>
                  <div id="habitGoalHelp" class="form-text">Set a weekly or yearly goal based on the selected frequency.</div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary">Add Habit</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Edit Habit Modal -->
        <div class="modal fade" id="editHabitModal" tabindex="-1" aria-labelledby="editHabitModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form id="editHabitForm">
                <div class="modal-header">
                  <h5 class="modal-title" id="editHabitModalLabel">Edit Habit</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <input type="hidden" id="editHabitPartnerIndex">
                  <input type="hidden" id="editHabitIndex">
                  <div class="mb-3">
                    <label for="editHabitTitle" class="form-label">Habit Title</label>
                    <input type="text" class="form-control" id="editHabitTitle" required>
                  </div>
                  <div class="mb-3">
                    <label for="editHabitFrequency" class="form-label">Frequency</label>
                    <select class="form-select" id="editHabitFrequency" required>
                      <option value="weekly">Weekly</option>
                      <option value="yearly">Yearly</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="editHabitGoal" class="form-label">Goal</label>
                    <input type="number" class="form-control" id="editHabitGoal" min="1" required>
                  </div>
                  <div id="editHabitGoalHelp" class="form-text">Set a weekly or yearly goal based on the selected frequency.</div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Delete All Data Confirmation Modal -->
        <div class="modal fade" id="deleteAllDataModal" tabindex="-1" aria-labelledby="deleteAllDataModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="deleteAllDataModalLabel">Delete All Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p class="text-danger">Are you sure you want to delete all data? This action cannot be undone.</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteAllDataBtn">Delete All Data</button>
              </div>
            </div>
          </div>
        </div>
      `;

      app.innerHTML=html;
      attachSettingsEvents();
    }

    // Attach Events for Settings Page
    function attachSettingsEvents(){
      // Firestore Configuration Form Submission
      document.getElementById('firestoreConfigForm')?.addEventListener('submit', (e)=>{
        e.preventDefault();
        const apiKey = document.getElementById('firebaseApiKey').value.trim();
        const authDomain = document.getElementById('firebaseAuthDomain').value.trim();
        const projectId = document.getElementById('firebaseProjectId').value.trim();

        if(!apiKey || !authDomain || !projectId){
          alert('Please fill in all Firestore configuration fields.');
          return;
        }

        const config = {
          apiKey,
          authDomain,
          projectId
        };

        // Save configuration to localStorage
        localStorage.setItem(FIRESTORE_CONFIG_STORAGE_KEY, JSON.stringify(config));
        firestoreSettings = config;

        // Initialize Firestore
        initFirestore(config);

        alert('Firestore configuration saved and connected.');

        // Hide the modal properly to remove the backdrop
        const modalElement = document.getElementById('firestoreConfigModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
          modal.hide();
        }
      });

      // Pre-populate Firestore Configuration Modal if settings exist
      const firestoreConfigModal = document.getElementById('firestoreConfigModal');
      firestoreConfigModal.addEventListener('show.bs.modal', () => {
        if (firestoreSettings) {
          document.getElementById('firebaseApiKey').value = firestoreSettings.apiKey || '';
          document.getElementById('firebaseAuthDomain').value = firestoreSettings.authDomain || '';
          document.getElementById('firebaseProjectId').value = firestoreSettings.projectId || '';
        } else {
          document.getElementById('firebaseApiKey').value = '';
          document.getElementById('firebaseAuthDomain').value = '';
          document.getElementById('firebaseProjectId').value = '';
        }
      });

      // Add Partner Form Submission
      document.getElementById('addPartnerForm')?.addEventListener('submit', (e)=>{
        e.preventDefault();
        const nameInput = document.getElementById('partnerName');
        const name = nameInput.value.trim();
        if(name === ''){
          alert('Partner name cannot be empty.');
          return;
        }
        // Check for duplicate partner name
        const duplicate = dataStore.partners.some(p => p.name.toLowerCase() === name.toLowerCase());
        if(duplicate){
          alert('A partner with this name already exists.');
          return;
        }
        // Add new partner
        dataStore.partners.push({ name, habits: [] });
        saveData();
        // Reset and close modal
        nameInput.value = '';
        // Update selected partners (select the new partner by default)
        selectedPartners.push(dataStore.partners.length -1);
        saveSelectedPartners();
        // Re-initialize dropdown
        initPartnersDropdown();
        // Hide the modal properly
        const addPartnerModal = bootstrap.Modal.getInstance(document.getElementById('addPartnerModal'));
        if (addPartnerModal) {
          addPartnerModal.hide();
        }
      });

      // Edit Partner Form Submission
      document.getElementById('editPartnerForm')?.addEventListener('submit', (e)=>{
        e.preventDefault();
        const pIndex = parseInt(document.getElementById('editPartnerIndex').value);
        const name = document.getElementById('editPartnerName').value.trim();
        if(name === ''){
          alert('Partner name cannot be empty.');
          return;
        }
        // Check for duplicate partner name excluding current
        const duplicate = dataStore.partners.some((p, index) => p.name.toLowerCase() === name.toLowerCase() && index !== pIndex);
        if(duplicate){
          alert('Another partner with this name already exists.');
          return;
        }
        // Update partner name
        dataStore.partners[pIndex].name = name;
        saveData();
        // Re-initialize dropdown
        initPartnersDropdown();
        // Hide the modal properly
        const editPartnerModal = bootstrap.Modal.getInstance(document.getElementById('editPartnerModal'));
        if (editPartnerModal) {
          editPartnerModal.hide();
        }
      });

      // Add Habit Form Submission
      document.getElementById('addHabitForm')?.addEventListener('submit', (e)=>{
        e.preventDefault();
        const pIndex = parseInt(document.getElementById('addHabitPartnerIndex').value);
        const title = document.getElementById('habitTitle').value.trim();
        const frequency = document.getElementById('habitFrequency').value;
        const goal = parseInt(document.getElementById('habitGoal').value);
        if(title === '' || isNaN(goal) || goal < 1){
          alert('Please provide a valid habit title and goal.');
          return;
        }
        // Check for duplicate habit title under the same partner
        const duplicate = dataStore.partners[pIndex].habits.some(h => h.title.toLowerCase() === title.toLowerCase());
        if(duplicate){
          alert('A habit with this title already exists for this partner.');
          return;
        }
        // Add new habit
        dataStore.partners[pIndex].habits.push({ title, frequency, goal, logs: {} });
        saveData();
        // Reset and close modal
        document.getElementById('habitTitle').value = '';
        document.getElementById('habitFrequency').value = 'weekly';
        document.getElementById('habitGoal').value = '';
        // Hide the modal properly
        const addHabitModal = bootstrap.Modal.getInstance(document.getElementById('addHabitModal'));
        if (addHabitModal) {
          addHabitModal.hide();
        }
      });

      // Edit Habit Form Submission
      document.getElementById('editHabitForm')?.addEventListener('submit', (e)=>{
        e.preventDefault();
        const pIndex = parseInt(document.getElementById('editHabitPartnerIndex').value);
        const hIndex = parseInt(document.getElementById('editHabitIndex').value);
        const title = document.getElementById('editHabitTitle').value.trim();
        const frequency = document.getElementById('editHabitFrequency').value;
        const goal = parseInt(document.getElementById('editHabitGoal').value);
        if(title === '' || isNaN(goal) || goal < 1){
          alert('Please provide a valid habit title and goal.');
          return;
        }
        // Check for duplicate habit title under the same partner excluding current
        const duplicate = dataStore.partners[pIndex].habits.some((h, index) => h.title.toLowerCase() === title.toLowerCase() && index !== hIndex);
        if(duplicate){
          alert('Another habit with this title already exists for this partner.');
          return;
        }
        // Update habit
        dataStore.partners[pIndex].habits[hIndex].title = title;
        dataStore.partners[pIndex].habits[hIndex].frequency = frequency;
        dataStore.partners[pIndex].habits[hIndex].goal = goal;
        saveData();
        // Re-initialize dropdown
        initPartnersDropdown();
        // Hide the modal properly
        const editHabitModal = bootstrap.Modal.getInstance(document.getElementById('editHabitModal'));
        if (editHabitModal) {
          editHabitModal.hide();
        }
      });

      // Remove Partner
      document.querySelectorAll('.remove-partner-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const pIndex = parseInt(e.target.getAttribute('data-partner-index'));
          const confirmDelete = confirm(`Are you sure you want to remove partner "${dataStore.partners[pIndex].name}"? This will also remove all their habits.`);
          if(confirmDelete){
            dataStore.partners.splice(pIndex, 1);
            saveData();
            // Remove from selectedPartners if present
            selectedPartners = selectedPartners.filter(index => index !== pIndex);
            // Update indices in selectedPartners that are greater than pIndex
            selectedPartners = selectedPartners.map(index => index > pIndex ? index -1 : index);
            saveSelectedPartners();
            // Re-initialize dropdown
            initPartnersDropdown();
            // Re-render settings page
            renderSettingsPage();
            // Re-render home and analytics
            renderHomePage();
            renderAnalyticsPage();
          }
        });
      });

      // Edit Partner Button Click
      document.querySelectorAll('.edit-partner-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const pIndex = parseInt(e.target.getAttribute('data-partner-index'));
          document.getElementById('editPartnerIndex').value = pIndex;
          document.getElementById('editPartnerName').value = dataStore.partners[pIndex].name;
        });
      });

      // Remove Habit
      document.querySelectorAll('.remove-habit-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const pIndex = parseInt(e.target.getAttribute('data-partner-index'));
          const hIndex = parseInt(e.target.getAttribute('data-habit-index'));
          const confirmDelete = confirm(`Are you sure you want to remove habit "${dataStore.partners[pIndex].habits[hIndex].title}"?`);
          if(confirmDelete){
            dataStore.partners[pIndex].habits.splice(hIndex, 1);
            saveData();
            // Re-render settings page
            renderSettingsPage();
            // Re-initialize dropdown
            initPartnersDropdown();
            // Re-render home and analytics
            renderHomePage();
            renderAnalyticsPage();
          }
        });
      });

      // Edit Habit Button Click
      document.querySelectorAll('.edit-habit-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const pIndex = parseInt(e.target.getAttribute('data-partner-index'));
          const hIndex = parseInt(e.target.getAttribute('data-habit-index'));
          document.getElementById('editHabitPartnerIndex').value = pIndex;
          document.getElementById('editHabitIndex').value = hIndex;
          document.getElementById('editHabitTitle').value = dataStore.partners[pIndex].habits[hIndex].title;
          document.getElementById('editHabitFrequency').value = dataStore.partners[pIndex].habits[hIndex].frequency;
          document.getElementById('editHabitGoal').value = dataStore.partners[pIndex].habits[hIndex].goal;
        });
      });

      // Add Habit Button Click - Set the partner index in the modal
      document.querySelectorAll('.add-habit-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const pIndex = parseInt(e.target.getAttribute('data-partner-index'));
          document.getElementById('addHabitPartnerIndex').value = pIndex;
          // Reset the form fields
          document.getElementById('habitTitle').value = '';
          document.getElementById('habitFrequency').value = 'weekly';
          document.getElementById('habitGoal').value = '';
        });
      });

      // Delete All Data Button Click
      document.getElementById('deleteAllDataBtn')?.addEventListener('click', ()=>{
        const deleteAllDataModal = new bootstrap.Modal(document.getElementById('deleteAllDataModal'));
        deleteAllDataModal.show();
      });

      // Confirm Delete All Data
      document.getElementById('confirmDeleteAllDataBtn')?.addEventListener('click', ()=>{
        // Clear localStorage
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(FIRESTORE_CONFIG_STORAGE_KEY);
        localStorage.removeItem(SELECTED_PARTNERS_KEY);
        dataStore = { partners: [] };
        selectedPartners = [];
        // Delete Firestore data
        if(firestore){
          firestore.collection('habitTrackers').doc('default').delete()
            .then(() => {
              console.log('All Firestore data deleted.');
            })
            .catch(err => {
              console.error('Error deleting Firestore data:', err);
              alert(`Error deleting Firestore data: ${err.message}`);
            });
        }
        // Re-initialize
        initPartnersDropdown();
        // Re-render settings, home, and analytics pages
        renderSettingsPage();
        renderHomePage();
        renderAnalyticsPage();
        // Hide the modal
        const deleteAllDataModal = bootstrap.Modal.getInstance(document.getElementById('deleteAllDataModal'));
        if (deleteAllDataModal) {
          deleteAllDataModal.hide();
        }
      });
    }

    // Render Analytics Page
    function renderAnalyticsPage(){
      const app=document.getElementById('app');
      if(!dataStore.partners.length){
        app.innerHTML=`
          <div class="text-center mt-5">
            <h3>Analytics</h3>
            <p class="text-muted">No partners yet. <a href="#/settings">Add them</a>.</p>
          </div>
        `;
        return;
      }
      if(selectedPartners.length === 0){
        app.innerHTML=`
          <div class="text-center mt-5">
            <h4>No Partners Selected</h4>
            <p class="text-muted">Please select at least one partner from the dropdown above.</p>
          </div>
        `;
        return;
      }
      let html=`
        <h2 class="mb-3">Analytics</h2>
        <div class="d-flex justify-content-center gap-2 mb-3 flex-wrap">
          <button class="btn btn-outline-dark btn-sm" id="btnWeekly">Weekly</button>
          <button class="btn btn-outline-dark btn-sm" id="btnMonthly">Monthly</button>
        </div>
      `;
      if(analyticsView==='weekly'){
        html+=renderWeeklyTrends();
      }else{
        html+=renderMonthlyTrends();
      }
      app.innerHTML=html;
      attachAnalyticsEvents();
    }
    function attachAnalyticsEvents(){
      document.getElementById('btnWeekly')?.addEventListener('click',()=>{
        analyticsView='weekly';
        renderAnalyticsPage();
      });
      document.getElementById('btnMonthly')?.addEventListener('click',()=>{
        analyticsView='monthly';
        renderAnalyticsPage();
      });
    }
    function renderWeeklyTrends(){
      let html='';
      selectedPartners.forEach(pIndex=>{
        const partner = dataStore.partners[pIndex];
        if(!partner.habits||!partner.habits.length)return;
        html+=`<h4 class="mb-2">${partner.name} (Weekly)</h4>`;
        partner.habits.forEach(habit=>{
          if(habit.frequency !== 'weekly') return; // Only include weekly habits
          const weeklyGoal=habit.goal>0?habit.goal:7;
          const stat=overallCompletion(habit.logs);
          const ratio=`${stat}/${weeklyGoal}`;
          const pct=Math.round((stat/weeklyGoal)*100);
          const color=stat>=weeklyGoal?'bg-success':'bg-warning';
          html+=`
            <div class="mb-3">
              <strong>${habit.title}</strong> (Goal: ${weeklyGoal})
              <div class="progress mt-1">
                <div class="progress-bar ${color}" role="progressbar" style="width: ${pct > 100 ? 100 : pct}%;" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="text-muted">${ratio} = ${pct}%</small>
            </div>
          `;
        });
      });
      return html;
    }
    function renderMonthlyTrends(){
      let html='';
      selectedPartners.forEach(pIndex=>{
        const partner = dataStore.partners[pIndex];
        if(!partner.habits||!partner.habits.length)return;
        html+=`<h4 class="mb-2">${partner.name} (Monthly)</h4>`;
        partner.habits.forEach(habit=>{
          if(habit.frequency !== 'yearly') return; // Only include yearly habits
          const yearlyGoal = habit.goal >0 ? habit.goal :1;
          const comp=monthlyCompletion(habit.logs);
          const ratio=`${comp}/${yearlyGoal}`;
          const pct=Math.round((comp/yearlyGoal)*100);
          const color=comp>=yearlyGoal?'bg-success':'bg-info';
          html+=`
            <div class="mb-3">
              <strong>${habit.title}</strong> (Yearly Goal: ${yearlyGoal})
              <div class="progress mt-1">
                <div class="progress-bar ${color}" role="progressbar" style="width: ${pct > 100 ? 100 : pct}%;" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="text-muted">${ratio} = ${pct}%</small>
            </div>
          `;
        });
      });
      return html;
    }

    // Compute Overall Completion for Analytics
    function overallCompletion(logs){
      let c=0;
      Object.keys(logs).forEach(d=>{
        if(logs[d].checked)c++;
      });
      return c;
    }
    function monthlyCompletion(logs){
      const now=new Date();
      const y=now.getFullYear();
      const m=now.getMonth();
      let c=0;
      Object.keys(logs).forEach(d=>{
        const parts=d.split('-');
        const yy=parseInt(parts[0],10);
        const mm=parseInt(parts[1],10)-1;
        if(yy===y&&mm===m&&logs[d].checked)c++;
      });
      return c;
    }

  </script>
</body>
</html>
