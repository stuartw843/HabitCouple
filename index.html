<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Couples Habit Tracker (No Modal on Heart, Current Streak Ignores Today)</title>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      background-color: #f0f8ff;
      font-family: Arial, sans-serif;
    }
    .navbar-brand {
      font-weight: bold;
    }
    table {
      white-space: nowrap;
    }
    @media (max-width: 576px) {
      h2.h5, .navbar-brand {
        font-size: 1rem;
      }
    }
    .heart-btn {
      cursor: pointer;
      font-size: 1.25rem;
      user-select: none;
      transition: color 0.2s;
      line-height: 1;
    }
    .heart-btn.empty {
      color: #ccc;
    }
    .heart-btn.filled {
      color: #ff69b4;
    }
    .fire-icon {
      color: #ff4500;
      margin-left: 0.25rem;
    }
    .analytics-bar-bg {
      background-color: #e9ecef;
      width: 100%;
      border-radius: 0.25rem;
    }
    .analytics-bar {
      height: 1rem;
      background-color: #ff69b4;
      transition: width 0.3s;
      border-radius: 0.25rem;
    }
    .today-cell {
      background-color: #fff3cd;
    }
    .modal-feeling {
      padding: 1rem;
      border-radius: 0.25rem;
      transition: background-color 0.2s;
    }
    .feeling-Great {
      background-color: #d1e7dd !important;
      color: #0f5132 !important;
    }
    .feeling-Good {
      background-color: #cff4fc !important;
      color: #055160 !important;
    }
    .feeling-Meh {
      background-color: #fff3cd !important;
      color: #664d03 !important;
    }
    .feeling-Bad {
      background-color: #f8d7da !important;
      color: #842029 !important;
    }
    .feeling-None {
      background-color: #e2e3e5 !important;
      color: #41464b !important;
    }
    .details-btn {
      transition: background-color 0.2s, color 0.2s;
    }
    .sync-indicator {
      font-size: 0.9rem;
      margin-left: 1rem;
      padding: 0.2rem 0.5rem;
      border-radius: 0.25rem;
    }
    .sync-indicator.connecting {
      background-color: #0dcaf0;
      color: #212529;
    }
    .sync-indicator.connected {
      background-color: #198754;
      color: #fff;
    }
    .sync-indicator.error {
      background-color: #dc3545;
      color: #fff;
    }
    .sync-indicator.idle {
      background-color: #6c757d;
      color: #fff;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#/home">Couples Habit Tracker</a>
      <span id="syncIndicator" class="sync-indicator idle">Idle</span>
      <div class="ms-auto d-flex gap-2">
        <a class="btn btn-outline-light" href="#/home">Home</a>
        <a class="btn btn-outline-light" href="#/analytics">Analytics</a>
        <a class="btn btn-outline-light" href="#/settings">Settings</a>
      </div>
    </div>
  </nav>

  <div class="container py-3" id="app"></div>

  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>

  <script>
    let firestoreSettings=null;
    let firestore=null;
    let firestoreState='idle';
    const FIRESTORE_CONFIG_STORAGE_KEY='couples-habit-tracker-firestore-config';
    const STORAGE_KEY='couples-habit-tracker-fun';
    let dataStore={partners:[]};
    let weekOffset=0;
    let analyticsView='weekly';

    function setFirestoreState(state){
      firestoreState=state;
      updateSyncIndicator();
    }
    function updateSyncIndicator(){
      const ind=document.getElementById('syncIndicator');
      ind.className=`sync-indicator ${firestoreState}`;
      ind.textContent=firestoreState.charAt(0).toUpperCase()+firestoreState.slice(1);
    }
    const savedLocal=localStorage.getItem(STORAGE_KEY);
    if(savedLocal){
      try{dataStore=JSON.parse(savedLocal);}catch{}
    }
    const savedFirestoreConfig=localStorage.getItem(FIRESTORE_CONFIG_STORAGE_KEY);
    if(savedFirestoreConfig){
      try{
        firestoreSettings=JSON.parse(savedFirestoreConfig);
      }catch{}
    }
    function initFirestore(config){
      setFirestoreState('connecting');
      try{
        firebase.initializeApp(config);
        firestore=firebase.firestore();
        attachFirestoreListener();
      }catch(err){
        firestore=null;
        console.error('Error init Firestore:',err);
        setFirestoreState('error');
        alert(`Error: ${err.message}`);
      }
    }
    function attachFirestoreListener(){
      if(!firestore){
        setFirestoreState('idle');
        return;
      }
      const docRef=firestore.collection('habitTrackers').doc('default');
      docRef.onSnapshot(
        (doc)=>{
          if(doc.exists){
            dataStore=doc.data()||{partners:[]};
            localStorage.setItem(STORAGE_KEY,JSON.stringify(dataStore));
            setFirestoreState('connected');
            router();
          }else{
            setFirestoreState('connected');
          }
        },
        (err)=>{
          console.error('Firestore listener error:',err);
          setFirestoreState('error');
          alert(`Firestore error: ${err.message}`);
        }
      );
    }
    function saveData(){
      localStorage.setItem(STORAGE_KEY,JSON.stringify(dataStore));
      if(firestore){
        setFirestoreState('connecting');
        firestore
          .collection('habitTrackers')
          .doc('default')
          .set(dataStore)
          .then(()=>{setFirestoreState('connected');})
          .catch((err)=>{
            console.error('Error saving Firestore:',err);
            setFirestoreState('error');
            alert(`Error saving Firestore: ${err.message}`);
          });
      }
    }

    const routes={
      '/home':renderHomePage,
      '/analytics':renderAnalyticsPage,
      '/settings':renderSettingsPage
    };
    function router(){
      const hash=window.location.hash||'#/home';
      const path=hash.replace('#','');
      (routes[path]||routes['/home'])();
    }
    window.addEventListener('hashchange',router);
    window.addEventListener('load',()=>{
      if(firestoreSettings){
        initFirestore(firestoreSettings);
      }else{
        setFirestoreState('idle');
        router();
      }
    });

    function getMondayWeekDates(offset=0){
      const now=new Date();
      const dayOfWeek=(now.getDay()+6)%7;
      now.setDate(now.getDate()-dayOfWeek+offset*7);
      const arr=[];
      for(let i=0;i<7;i++){
        const d=new Date(now);
        d.setDate(d.getDate()+i);
        const dateStr=d.toISOString().split('T')[0];
        const label=d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
        arr.push({dateStr,label});
      }
      return arr;
    }

    function renderHomePage(){
      const app=document.getElementById('app');
      const days=getMondayWeekDates(weekOffset);
      if(!dataStore.partners.length){
        app.innerHTML=`
          <div class="text-center mt-5">
            <h3>Welcome!</h3>
            <p class="text-muted">No partners yet. <a href="#/settings">Add some</a>.</p>
          </div>
        `;
        return;
      }
      let html=`
        <div class="d-flex justify-content-center align-items-center mb-3 gap-2">
          <button id="btnPrev" class="btn btn-sm btn-secondary">‚Üê Prev</button>
          <button id="btnThisWeek" class="btn btn-sm btn-light">This Week</button>
          <button id="btnNext" class="btn btn-sm btn-secondary">Next ‚Üí</button>
        </div>
        <div class="modal fade" id="detailsModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content" id="detailsModalContent"></div>
          </div>
        </div>
      `;
      dataStore.partners.forEach((partner,pIndex)=>{
        html+=`
          <div class="mb-4">
            <h2 class="h5 mb-2">${partner.name}'s Habits</h2>
            ${renderHabitsTable(partner,pIndex,days)}
          </div>
        `;
      });
      app.innerHTML=html;
      attachHomeEvents();
    }
    function renderHabitsTable(partner,pIndex,days){
      if(!partner.habits||!partner.habits.length){
        return`<p class="text-muted">No habits yet. <a href="#/settings">Add some</a>.</p>`;
      }
      let table=`
        <div class="table-responsive">
          <table class="table table-bordered align-middle text-center">
            <thead class="table-light">
              <tr>
                <th style="min-width:160px;">Habit</th>
      `;
      const todayStr=new Date().toISOString().split('T')[0];
      days.forEach(({label,dateStr})=>{
        table+=`
          <th style="width:120px;">
            <div>${label}</div>
            <div class="small text-muted">${dateStr}</div>
          </th>
        `;
      });
      table+=`
                <th>Progress</th>
              </tr>
            </thead>
            <tbody>
      `;
      partner.habits.forEach((habit,hIndex)=>{
        if(!habit.logs)habit.logs={};
        const weeklyGoal=habit.goal>0?habit.goal:7;
        const monthlyGoal=weeklyGoal*4;
        const currentStreak=computeCurrentStreakIgnoringToday(habit.logs);
        table+=`
          <tr>
            <td class="text-start">
              <strong>${habit.title}</strong>
              <br>
              <small class="text-muted">(Weekly: ${weeklyGoal}, Monthly: ${monthlyGoal})</small>
              ${currentStreak>0?`<span class="fire-icon">üî• x${currentStreak}</span>`:''}
            </td>
        `;
        const {count,percent}=computeGoalProgress(habit,days);
        days.forEach(({dateStr})=>{
          if(!habit.logs[dateStr]){
            habit.logs[dateStr]={checked:false,notes:'',feeling:'None'};
          }
          const logs=habit.logs[dateStr];
          const isFilled=logs.checked?'filled':'empty';
          const highlight=dateStr===todayStr?'today-cell':'';
          table+=`
            <td class="${highlight}">
              <span
                class="heart-btn ${isFilled}"
                data-partner-index="${pIndex}"
                data-habit-index="${hIndex}"
                data-datestr="${dateStr}"
              >
                ${isFilled==='filled'?'‚ô•':'‚ô°'}
              </span>
              <br />
              <button
                class="btn btn-sm details-btn mt-1 feeling-${logs.feeling}"
                data-partner-index="${pIndex}"
                data-habit-index="${hIndex}"
                data-datestr="${dateStr}"
                data-bs-toggle="modal"
                data-bs-target="#detailsModal"
              >
                Details
              </button>
            </td>
          `;
        });
        const color=count>=weeklyGoal?'text-success fw-bold':'';
        table+=`
            <td class="${color}">
              ${count}/${weeklyGoal} (${percent}%)
            </td>
          </tr>
        `;
      });
      table+=`</tbody></table></div>`;
      return table;
    }
    function attachHomeEvents(){
      document.getElementById('btnPrev')?.addEventListener('click',()=>{
        weekOffset--;
        renderHomePage();
      });
      document.getElementById('btnNext')?.addEventListener('click',()=>{
        weekOffset++;
        renderHomePage();
      });
      document.getElementById('btnThisWeek')?.addEventListener('click',()=>{
        weekOffset=0;
        renderHomePage();
      });
      document.querySelectorAll('.heart-btn').forEach((el)=>{
        el.addEventListener('click',()=>{
          const pIndex=+el.dataset.partnerIndex;
          const hIndex=+el.dataset.habitIndex;
          const d=el.dataset.datestr;
          const habit=dataStore.partners[pIndex].habits[hIndex];
          if(!habit.logs[d]){
            habit.logs[d]={checked:false,notes:'',feeling:'None'};
          }
          const wasChecked=habit.logs[d].checked;
          habit.logs[d].checked=!wasChecked;
          if(wasChecked){
            // Clear logs if unchecking
            habit.logs[d].notes='';
            habit.logs[d].feeling='None';
          }
          saveData();
          renderHomePage(); // Do NOT open the modal
        });
      });
      document.querySelectorAll('.details-btn').forEach((b)=>{
        b.addEventListener('click',()=>{
          const p=+b.dataset.partnerIndex;
          const h=+b.dataset.habitIndex;
          const d=b.dataset.datestr;
          openDetailsModal(p,h,d);
        });
      });
    }
    function openDetailsModal(pIndex,hIndex,dateStr){
      const habit=dataStore.partners[pIndex].habits[hIndex];
      if(!habit.logs[dateStr]){
        habit.logs[dateStr]={checked:false,notes:'',feeling:'None'};
      }
      const logs=habit.logs[dateStr];
      const modal=document.getElementById('detailsModalContent');
      const feelings=['Great','Good','Meh','Bad','None'];
      let feelingOptions='';
      feelings.forEach((f)=>{
        const sel=logs.feeling===f?'selected':'';
        feelingOptions+=`<option value="${f}" ${sel}>${f}</option>`;
      });
      modal.innerHTML=`
        <div class="modal-header">
          <h5 class="modal-title">Details for ${habit.title} on ${dateStr}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-feeling feeling-${logs.feeling}" id="detailsModalBody">
          <div class="mb-3">
            <label class="form-label"><strong>Notes:</strong></label>
            <textarea class="form-control" rows="3" id="modalNotes">${logs.notes||''}</textarea>
          </div>
          <div>
            <label class="form-label"><strong>Feeling:</strong></label>
            <select class="form-select" id="modalFeeling">${feelingOptions}</select>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-primary"
            id="saveDetailsBtn"
            data-bs-dismiss="modal"
          >
            Save
          </button>
        </div>
      `;
      document.getElementById('modalFeeling').addEventListener('change',(e)=>{
        const val=e.target.value||'None';
        const body=document.getElementById('detailsModalBody');
        body.className=`modal-feeling feeling-${val}`;
      });
      document.getElementById('saveDetailsBtn').addEventListener('click',()=>{
        const n=document.getElementById('modalNotes').value;
        const f=document.getElementById('modalFeeling').value;
        habit.logs[dateStr].notes=n;
        habit.logs[dateStr].feeling=f;
        saveData();
        renderHomePage();
      });
    }
    function renderAnalyticsPage(){
      const app=document.getElementById('app');
      if(!dataStore.partners.length){
        app.innerHTML=`
          <div class="text-center mt-5">
            <h3>Analytics</h3>
            <p class="text-muted">No partners yet. <a href="#/settings">Add them</a>.</p>
          </div>
        `;
        return;
      }
      let html=`
        <h2 class="mb-3">Analytics</h2>
        <div class="d-flex justify-content-center gap-2 mb-3">
          <button class="btn btn-outline-dark" id="btnWeekly">Weekly</button>
          <button class="btn btn-outline-dark" id="btnMonthly">Monthly</button>
        </div>
      `;
      if(analyticsView==='weekly'){
        html+=renderWeeklyTrends();
      }else{
        html+=renderMonthlyTrends();
      }
      app.innerHTML=html;
      attachAnalyticsEvents();
    }
    function attachAnalyticsEvents(){
      document.getElementById('btnWeekly')?.addEventListener('click',()=>{
        analyticsView='weekly';
        renderAnalyticsPage();
      });
      document.getElementById('btnMonthly')?.addEventListener('click',()=>{
        analyticsView='monthly';
        renderAnalyticsPage();
      });
    }
    function renderWeeklyTrends(){
      let html='';
      dataStore.partners.forEach(partner=>{
        if(!partner.habits||!partner.habits.length)return;
        html+=`<h4 class="mb-2">${partner.name} (Weekly)</h4>`;
        partner.habits.forEach(habit=>{
          const weeklyGoal=habit.goal>0?habit.goal:7;
          const stat=overallCompletion(habit.logs);
          const ratio=`${stat}/${weeklyGoal}`;
          const pct=Math.round((stat/weeklyGoal)*100);
          const color=stat>=weeklyGoal?'bg-success':'bg-warning';
          html+=`
            <div class="mb-3">
              <strong>${habit.title}</strong> (Goal: ${weeklyGoal})
              <div class="analytics-bar-bg mt-1">
                <div
                  class="analytics-bar ${color}"
                  style="width:${pct>100?100:pct}%;"
                ></div>
              </div>
              <div class="small text-muted">${ratio} = ${pct}%</div>
            </div>
          `;
        });
      });
      return html;
    }
    function renderMonthlyTrends(){
      let html='';
      dataStore.partners.forEach(partner=>{
        if(!partner.habits||!partner.habits.length)return;
        html+=`<h4 class="mb-2">${partner.name} (Monthly)</h4>`;
        partner.habits.forEach(habit=>{
          const weeklyGoal=habit.goal>0?habit.goal:7;
          const monthlyGoal=weeklyGoal*4;
          const comp=monthlyCompletion(habit.logs);
          const ratio=`${comp}/${monthlyGoal}`;
          const pct=Math.round((comp/monthlyGoal)*100);
          const color=comp>=monthlyGoal?'bg-success':'bg-info';
          html+=`
            <div class="mb-3">
              <strong>${habit.title}</strong> (Monthly Goal: ${monthlyGoal})
              <div class="analytics-bar-bg mt-1">
                <div
                  class="analytics-bar ${color}"
                  style="width:${pct>100?100:pct}%;"
                ></div>
              </div>
              <div class="small text-muted">${ratio} = ${pct}%</div>
            </div>
          `;
        });
      });
      return html;
    }

    function renderSettingsPage(){
      const app=document.getElementById('app');
      let html=`
        <h2 class="mb-3">Settings</h2>
        <div class="card card-body mb-3">
          <h5>Firestore Config</h5>
          <div class="mb-3">
            <label class="form-label">API Key</label>
            <input type="text" class="form-control" id="inputApiKey" />
          </div>
          <div class="mb-3">
            <label class="form-label">Auth Domain</label>
            <input type="text" class="form-control" id="inputAuthDomain" />
          </div>
          <div class="mb-3">
            <label class="form-label">Project ID</label>
            <input type="text" class="form-control" id="inputProjectId" />
          </div>
          <button class="btn btn-primary mb-3" id="btnSetFirestore">Set Firestore</button>
          <hr />
          <h5>Add a New Partner</h5>
          <div class="input-group mb-3">
            <input
              type="text"
              class="form-control"
              id="inputNewPartnerName"
              placeholder="Partner Name"
            />
            <button class="btn btn-primary" id="btnAddPartner">Add Partner</button>
          </div>
          <hr />
          <h5>Partners & Habits</h5>
          <div id="partnersSettings"></div>
        </div>
        <div class="text-center mt-4">
          <button id="btnResetWeek" class="btn btn-warning me-2">Reset This Week's Logs</button>
          <button id="btnResetAll" class="btn btn-warning me-2">Reset All Logs</button>
          <button id="btnClearData" class="btn btn-danger me-2">Clear All Data</button>
          <button id="btnPrintData" class="btn btn-secondary">Console Log Data</button>
        </div>
      `;
      app.innerHTML=html;
      renderPartnersSettings();
      attachSettingsEvents();
      if(firestoreSettings){
        document.getElementById('inputApiKey').value=firestoreSettings.apiKey||'';
        document.getElementById('inputAuthDomain').value=firestoreSettings.authDomain||'';
        document.getElementById('inputProjectId').value=firestoreSettings.projectId||'';
      }
    }
    function renderPartnersSettings(){
      const c=document.getElementById('partnersSettings');
      if(!dataStore.partners.length){
        c.innerHTML=`<p class="text-muted">No partners yet.</p>`;
        return;
      }
      let html='';
      dataStore.partners.forEach((partner,pIndex)=>{
        html+=`
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">${partner.name}</h6>
              <button
                class="btn btn-sm btn-outline-danger"
                data-remove-partner
                data-index="${pIndex}"
              >
                Remove Partner
              </button>
            </div>
            <div class="card card-body mb-2">
              <div class="row g-2">
                <div class="col-md-5">
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Habit Title"
                    id="inputNewHabitTitle-${pIndex}"
                  />
                </div>
                <div class="col-md-3">
                  <input
                    type="number"
                    class="form-control"
                    placeholder="Goal"
                    id="inputNewHabitGoal-${pIndex}"
                  />
                </div>
                <div class="col-md-4">
                  <button
                    class="btn btn-success w-100"
                    data-add-habit
                    data-partner-index="${pIndex}"
                  >
                    Add Habit
                  </button>
                </div>
              </div>
              <small class="text-muted">E.g., "Drink Water" w/Goal=5</small>
            </div>
        `;
        if(!partner.habits||!partner.habits.length){
          html+=`<p class="text-muted">No habits yet.</p>`;
        }else{
          html+=`<ul class="list-group">`;
          partner.habits.forEach((habit,hIndex)=>{
            html+=`
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>
                  <strong>${habit.title}</strong>
                  <em class="text-muted">Goal: ${habit.goal||0}</em>
                </span>
                <button
                  class="btn btn-sm btn-outline-danger"
                  data-remove-habit
                  data-partner-index="${pIndex}"
                  data-habit-index="${hIndex}"
                >
                  Remove
                </button>
              </li>
            `;
          });
          html+=`</ul>`;
        }
        html+=`</div>`;
      });
      c.innerHTML=html;
    }
    function attachSettingsEvents(){
      document.getElementById('btnSetFirestore')?.addEventListener('click',()=>{
        const apiKey=document.getElementById('inputApiKey').value.trim();
        const authDomain=document.getElementById('inputAuthDomain').value.trim();
        const projectId=document.getElementById('inputProjectId').value.trim();
        if(!apiKey||!authDomain||!projectId){
          alert('Please fill in all Firestore config fields.');
          return;
        }
        firestoreSettings={apiKey,authDomain,projectId};
        localStorage.setItem(FIRESTORE_CONFIG_STORAGE_KEY,JSON.stringify(firestoreSettings));
        initFirestore(firestoreSettings);
      });
      document.getElementById('btnAddPartner')?.addEventListener('click',()=>{
        const name=document.getElementById('inputNewPartnerName').value.trim();
        if(!name)return;
        dataStore.partners.push({name,habits:[]});
        document.getElementById('inputNewPartnerName').value='';
        saveData();
        renderSettingsPage();
      });
      document.querySelectorAll('[data-remove-partner]').forEach((b)=>{
        b.addEventListener('click',()=>{
          const idx=+b.dataset.index;
          const partnerName=dataStore.partners[idx].name;
          if(!confirm(`Remove "${partnerName}"?`))return;
          dataStore.partners.splice(idx,1);
          saveData();
          renderSettingsPage();
        });
      });
      document.querySelectorAll('[data-add-habit]').forEach((b)=>{
        b.addEventListener('click',()=>{
          const pIndex=+b.dataset.partnerIndex;
          const t=document.getElementById(`inputNewHabitTitle-${pIndex}`).value.trim();
          const g=parseInt(document.getElementById(`inputNewHabitGoal-${pIndex}`).value.trim()||'0',10);
          if(!t)return;
          dataStore.partners[pIndex].habits.push({title:t,goal:g,logs:{}});
          document.getElementById(`inputNewHabitTitle-${pIndex}`).value='';
          document.getElementById(`inputNewHabitGoal-${pIndex}`).value='';
          saveData();
          renderSettingsPage();
        });
      });
      document.querySelectorAll('[data-remove-habit]').forEach((b)=>{
        b.addEventListener('click',()=>{
          const pIndex=+b.dataset.partnerIndex;
          const hIndex=+b.dataset.habitIndex;
          const habitTitle=dataStore.partners[pIndex].habits[hIndex].title;
          if(!confirm(`Remove "${habitTitle}"?`))return;
          dataStore.partners[pIndex].habits.splice(hIndex,1);
          saveData();
          renderSettingsPage();
        });
      });
      document.getElementById('btnResetWeek')?.addEventListener('click',()=>{
        if(!confirm('Reset logs for this Monday-based 7-day window?'))return;
        const days=getMondayWeekDates(weekOffset);
        dataStore.partners.forEach(p=>{
          p.habits.forEach(h=>{
            days.forEach(({dateStr})=>{
              if(h.logs[dateStr])delete h.logs[dateStr];
            });
          });
        });
        saveData();
        alert('Logs reset for this Monday-based week.');
      });
      document.getElementById('btnResetAll')?.addEventListener('click',()=>{
        if(!confirm('Reset ALL logs?'))return;
        dataStore.partners.forEach(p=>{
          p.habits.forEach(h=>{
            h.logs={};
          });
        });
        saveData();
        alert('All logs have been reset.');
      });
      document.getElementById('btnClearData')?.addEventListener('click',()=>{
        if(!confirm('Really CLEAR ALL data?'))return;
        localStorage.removeItem(STORAGE_KEY);
        dataStore={partners:[]};
        if(firestore){
          setFirestoreState('connecting');
          firestore
            .collection('habitTrackers')
            .doc('default')
            .delete()
            .then(()=>{setFirestoreState('connected');})
            .catch((err)=>{
              console.error('Error deleting Firestore doc:',err);
              setFirestoreState('error');
              alert(`Error deleting data in Firestore: ${err.message}`);
            });
        }
        alert('All data has been cleared!');
        renderSettingsPage();
      });
      document.getElementById('btnPrintData')?.addEventListener('click',()=>{
        console.log(JSON.stringify(dataStore,null,2));
        alert('Data logged to console!');
      });
    }

    function computeGoalProgress(habit,days){
      let c=0;
      days.forEach(({dateStr})=>{
        if(habit.logs[dateStr]?.checked)c++;
      });
      const weeklyGoal=habit.goal>0?habit.goal:7;
      const pct=Math.round((c/weeklyGoal)*100);
      return{count:c,percent:pct};
    }
    function overallCompletion(logs){
      let c=0;
      Object.keys(logs).forEach(d=>{
        if(logs[d].checked)c++;
      });
      return c;
    }
    function monthlyCompletion(logs){
      const now=new Date();
      const y=now.getFullYear();
      const m=now.getMonth();
      let c=0;
      Object.keys(logs).forEach(d=>{
        const parts=d.split('-');
        const yy=parseInt(parts[0],10);
        const mm=parseInt(parts[1],10)-1;
        if(yy===y&&mm===m&&logs[d].checked)c++;
      });
      return c;
    }

    /* Current streak ignoring today's day: 
       If today is unchecked, we do NOT break the streak. 
       We'll skip today's date in the streak logic entirely. 
       We'll only measure up to yesterday's date. 
    */
    function computeCurrentStreakIgnoringToday(logs){
      const sortedDates=Object.keys(logs).sort();
      const now=new Date();
      const todayStr=now.toISOString().split('T')[0];
      const yesterday=new Date(now);
      yesterday.setDate(now.getDate()-1);
      const yStr=yesterday.toISOString().split('T')[0];

      // We'll only consider days <= yesterday
      let streak=0;
      let prevDate=null;
      for(let i=0;i<sortedDates.length;i++){
        const dStr=sortedDates[i];
        if(dStr>yStr)break;
        if(!logs[dStr].checked){
          streak=0;
          prevDate=null;
          continue;
        }
        if(!prevDate){
          streak=1;
        }else{
          const pd=new Date(prevDate);
          const cd=new Date(dStr);
          const diff=(cd-pd)/(1000*3600*24);
          if(diff===1){
            streak++;
          } else {
            streak=1;
          }
        }
        prevDate=dStr;
      }
      return streak;
    }
  </script>
</body>
</html>
